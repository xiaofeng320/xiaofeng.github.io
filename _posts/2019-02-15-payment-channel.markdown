---
layout:     post
title:      "支付系统-通道搭建"
subtitle:   " \"支付系统\""
date:       2019-02-15 11:00:00
author:     "xiaofeng"
header-img: "img/WechatIMG12.jpeg"
tags:
    - 支付 
    - 技术
    - 支付通道
---


### 业务请求流程

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gdrzwbl461j30js0dx74z.jpg)

* 规则校验
  * 输入参数完整性和正确性的校验
  * 账户状态，是否被冻结
  * 支付订单，是否有进行中的支付订单
  * 签名校验，防止关键接口被伪造，输入的参数做MD5或RSA加密，各个语言最好封装成SDK。

* 确定支付通道
  * 根据支付类型和支付动作，确定要使用的支付通道。
  
* 生成支付订单
  * 每次请求生产一笔支付订单并持久化，方便后续对账和状态机流转。
  
* 异步更新订单
  * 因为要访问外部第三方平台，尽量保障各个通道都是异步化。否则会因为对方服务不稳定导致自己系统抖动。
  
* 异步通知
  * 内部服务采用异步通知方式进行信息专递，调用方提供一个Notice_url,协议采用http或者rpc协议。


### 支付类型

支付通道上层抽象一层支付类型，包含网页支付、绑卡支付、wap支付、绑卡支付、免密支付等，每个支付类型又包含特定支付通道。每种动作的通用函数都写在type层，简化代码，降低后期维护成本。

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gds0a2y9ndj30ha03zmxu.jpg)

### 支付通道产品

按接入和使用场景不同，支付产品分为：

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gds5fapcg0j30ws0i6gom.jpg)

**快捷支付：** 快捷支付指用户购买商品时，不需开通网银，只需提供银行卡卡号、户名、手机号码等信息，银行验证手机号码正确性后，第三方支付发送手机动态口令到用户手机号上，用户输入正确的手机动态口令，即可完成支付。[百度百科]

**网银支付：** 网银支付，即网上银行支付，是即时到帐交易。网银支付是银联最为成熟的在线支付功能之一，也是网民在线支付的首选方式，是国内电子商务企业提供在线交易服务不可或缺的功能之一。其特点是银行卡需事先开通网银支付功能，且在支付时完全是在银行网银页面输入银行卡信息并验证支付密码，具有稳定易用，安全可靠的特点。[百度百科]

**SDK支付：** 用户需要预先安装好支付渠道适配的APP到手机上（支付宝、微信、招行APP等），并且在三方支付APP内注册并配置好钱包功能。由于近几年的大面积推广和使用上具有的便捷性。SDK支付现在是最主要的代收通道了。

为了适应业务发展和灵活性，单一渠道下也要细分不同的子主体。

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gds4hte9ycj31ia0pigsy.jpg)

**代付：** 平台代为付款给客户，这块业务和合规比较麻烦

**服务商：** 微信服务商为例，服务商是指有技术开发能力的第三方开发者为普通商户提供微信支付技术开发、营销方案，即服务商可在微信支付开放的服务商高级接口的基础上，为商户完成支付申请、技术开发、机具调试、活动营销等全生态链服务。[微信帮助文档]

支付的功能和常规商户相同，特约商户授权后，服务商就可以代为做支付下单。

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gds5dgul53j30n2096q3y.jpg)

服务商操作权限介绍

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gds5dqy1lcj30na0apq4c.jpg)


### 支付功能

* 支付下单
  
* 查询
  
* 退款和关闭订单
  
* 对账
  
* 预授权


### 支付宝接口

支付宝接口参数分为两部分，公共参数和请求参数。响应包含公共响应参数和响应参数。

* 公共参数

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gdsaafvj9dj30ve0h90va.jpg)

签名规则：参数按key排序后，在RSA处理后放入到sign参数中。

* 请求参数

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gdsa4imziyj30v00a842f.jpg)

bizContent里存储的就是请求参数

* 公共响应参数
  
![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gdsaeixt5xj30vl0bc400.jpg)


* 响应参数

最终返回前端的是```result``` 值



### 微信接口

微信拼接XML数据格式进行传输,根据官方的SDK要做一些定制化的开发。
* 配置文件之前写到常量里了，改为读取配置数据。
* 接入服务商支付后，在这基础上要增加几个参数。
* 升级到php7，有些函数要调整。


### 其他对接

银行大多数是直联或者专线方式对接，要插Ukey还要windows机器，文档和对接的成本要高一些。联动优势、连连支付等第三方对接还好，但使用过程中会遇到一些文档里没有体现的问题，需要和对方技术沟通解决。

### 问题

**服务抖动**

某一方的服务不稳定时，但等请求一方去提醒就很被动，对接的通道就遇到过这种情况，感觉本身的监控做的不是很到位。支付宝体验就很好，会监控notice情况，一次因为机房被恶意攻击，没一会支付宝BD就把异常截图发了过来。

**https**

经历过被动升级https，某一天接口报错，反馈了告诉升级到https，真是没有一丝丝防备。
还有就是不支持https，嵌套支付https不能嵌套http页面。

**对接**

需要windows机器，需要插ukey对接，因为现有服务都部署到云服务了，物理机不好做高可用，自动加载有时也不稳定，需要协调人工处理。



参考：
凤凰牌老熊：http://doc.cocolian.cn/

