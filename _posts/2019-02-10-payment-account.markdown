---
layout:     post
title:      "支付系统账户系统"
subtitle:   " \"支付系统\""
date:       2019-02-09 11:00:00
author:     "xiaofeng"
header-img: "img/WechatIMG43.jpeg"
tags:
    - 支付 
    - 技术
    - 账户
---

> 接下来介绍下账户、支付流程、结算、支付通道、服务监控。

## 设计目的

* 交易需求，内部服务支持。支付方式路由判别，余额情况。
* 账簿需求，财务对账支持。有进有出的流水账，通过不同行为进行筛选。数据能够对接财务系统。
* 对账需求，内部侧数据对账，渠道对账，外部三方通道的对账支持。
* 监控需求，能够支持服务稳定的监控，配合风控进行风险商户的判别。

> **part1 支付账户**

    账户属性包含：信用（授信额度）、余额、状态、类型.
    账户模型包含：常规账户、活动充值账户、活动返现账户、积分账户、提现账户、发票账户等等
    明细包含：消费明细、账户明细、通道交易明细

### 属性

1. 账户ID：用户和企业在账户的唯一ID，作为分库分表、锁的依据。
2. 信用：主要是给企业一些授信额度，相当于信用卡效果。不建议随意使用该功能，可能会造成大范围坏账。
3. 状态：正常状态和冻结状态。冻结状态主要依据风控判定，自动或手动的停止账户功能的使用。状态变更已广播的形式推到MQ中，配合业务做短信或邮件发送。
4. 类型：不止企业和个人，还能细分到劳务方（司机、租赁公司、劳务公司），消费方（渠道、企业、个人）等
   
### 账户模型
1. 常规账户：常规充值操作的余额账户，和活动充值区分，这类账户可以退款。
2. 活动充值账户：通过各种活动入口充值余额账户，该类账户无过期时间，不可以退款。
3. 活动返现账户：复合活动规则返现账户，该类账户有过期时间，不可以退款。此类bucket账户每个用户会有多个，每个活动对应一个bucket，通过activity_id和expire_time判别活动归属和是否失效。
4. 积分账户：和返现账户类似，用户投保或完成其他任务，赠送积分。积分账户一般只有一个，过期计算规则根据业务决定。如果是增量失效，只能通过计算消费推导出要失效积分值。
5. 提现账户：可提现的账户，结算系统、风控系统规则计算后（举例子t+n提现），入账后客户申请后平台就代付给客户。
6. 发票账户：一种特殊类型账户，充值或用车后将可开发票金额记录到账户中。主要保证返现账户，积分账户，提现账户（需要企业给平台开发票）不能记录发票到余额。

### 账户明细
1. 消费明细：内部服务间对账依据。包含：充值、订单支付、提现、结算、积分等动作。消费模式：账户、活动、组合等。"deduct_level"确定扣款顺序。默认扣款方式(TSM),充返账户等比例扣减，不足扣减主账户（这也要看业务规则）。“notice_url”和“notice_status”内部异步通知地址和状态。尝试次数为

    ```
    public static $delayArr = array(1,1,1,3,5,10,60,600,1800,3600);
    ```
2. 账户明细：财务账簿，实际发生账户变化后账户记录的流水账。
   * 余额支付有一条流水。
   * 充值并支付有一进一出两条流水。
   * 调整订单金额有一出一进一出三条流水。

3. 通道交易明细：三方通道对账依据。商户id要保证唯一性（生成器用的雪花算法），请求数据快照也要记录一下（代付场景好追溯到银行账户）。支付通道参数也要记录一下，代收可能用的北京分公司，代付用的是上海分公司。微信相对支付宝比较麻烦的一点是open_id是随机串，不是手机号。在对接微信服务商也要记录一下sub_app_id、sub_mch_id、sub_open_id等参数。数据建模时候，要分析好业务需要按哪些维度进行数据查询。确定好建立哪些字段，哪些记录到快照中，哪些记录的日志数据中（比较典型的就是三方下单失败后返回的错误信息）。
   

> **part2 支付动作**

![](https://tva1.sinaimg.cn/large/00831rSTly1gdlbj7djw5j30vr0jxabl.jpg)

### 订单支付

简单的订单支付流程，实际流程要比这个复杂的多。但也是在这个流程上做一些业务判断。
*   扣款的动作，是优先扣常规账户，还是充返账户。
*   余额不足，可以司机当面收现金或者走第三方通道。
*   支付成功后，对订单进行的多方分佣。

![](https://tva1.sinaimg.cn/large/00831rSTly1gdlco3i1w4j30hn0gn74h.jpg)

如果订单金额有疑议，要调整金额的话，还要冲正。

![](https://tva1.sinaimg.cn/large/00831rSTly1gdlcrkm2t5j30gt0fhdge.jpg)

* 要对结算数据做先出后进的方式进行冲正。
* 退款的规则要确定，现金，三方还是余额。

### 活动

活动的设计要考虑和支付系统解耦，充和返要给前端服务提供独立的接口。已充值返现为例：

![](https://tva1.sinaimg.cn/large/00831rSTly1gdlctuo923j30n40d0hdt.jpg)

* UC（用户中心），用户通过h5页面进行充值操作时，需要把activity_id,user_id等关键信息附带在“notice_url”中，支付系统异步通知UC充值成功。
* UC在根据activity_id匹配活动规则，决定调用返现接口还是积分接口。这样支付系统是不需要知道这笔请求是常规充值还是活动充值。

### 提现

提现这里需要注意的
* 手续费，提现的通道费还是比较高的。
* 合规，保障流程合规，财务流不能平台直接到司机。因为二者之间没有劳务关系。
* 备付金，通道需要保障备付金的财务流程一致性。也是为了合规



> 上面几种动作风险相关问题，这里先不讨论，后面专门篇章介绍。


**参考：**

[凤凰牌老熊](http://doc.cocolian.cn/)

