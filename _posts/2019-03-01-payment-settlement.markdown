---
layout:     post
title:      "支付系统-通道搭建"
subtitle:   " \"支付系统\""
date:       2019-03-01 11:00:00
author:     "xiaofeng"
header-img: "img/WechatIMG13.jpeg"
tags:
    - 支付 
    - 技术
    - 结算
    - 监控
---


### 结算和对账

#### 内部结算

1、基础数据

反范式去设计数据结构，尽可能去冗余字段（可以记录快照）。方便大数据量账单生成时关联其他表导致的性能下降。

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gduhm77u4fj30lg09l3yt.jpg)

2、账单

每种业务场景结算数据需求都是不同的，相同业务在不同时期结算需求也有很大差异。比如前期结算周期是按天，之后按周，按月出账单等。又有可能按供应商，生效时间进行拆分，某一单被风控要单独撤掉等场景。账单时间依据记账时间做基准，不能参照订单时间，否则可能出现跨月丢数据的情况。另外账单的出单规则要保持灵活，能够快速适配（此处的测试和上线的难度要大于开发难度，上线前要备份好数据库）。

数据量过大时，cron会造成服务器监控报警，要及时和运维沟通处理。还有大夜上线也要避开cron跑的时间（有的cron跑的时间比较长）。

3、数据处理

不能手动修改结算的基础数据（状态除外），分佣错误的情况要通过订单冲正的方式修正。


### 通道侧对账

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gduk5mzgelj30le0a4q3d.jpg)

支付宝、微信是http方式去拉取数据，有的银企直联系统是提供给他ftp服务，他定期推送给你账单数据。可以用备库和csv文件进行比对，匹配出差异数据。


### 监控

这里不考虑系统监控，只关注服务监控。通过以下几个维度进行监控数据搭建。

1、支付接口监控

* 吞吐量
* 响应时间
* 异常数

2、支付通道监控

* 交易次数
* 交易人数
* 交易金额
* 交易耗时
* 交易成功率

3、商户监控

* 交易次数
* 交易人数
* 交易金额


参考：
凤凰牌老熊：http://doc.cocolian.cn/

